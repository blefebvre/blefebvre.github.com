<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: dispatcher | Bruce Lefebvre]]></title>
  <link href="http://brucelefebvre.com/blog/categories/dispatcher/atom.xml" rel="self"/>
  <link href="http://brucelefebvre.com/"/>
  <updated>2013-09-18T15:34:14-04:00</updated>
  <id>http://brucelefebvre.com/</id>
  <author>
    <name><![CDATA[Bruce Lefebvre]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Setting up a Dispatcher on OS X]]></title>
    <link href="http://brucelefebvre.com/blog/2013/08/22/setting-up-a-dispatcher-on-os-x/"/>
    <updated>2013-08-22T22:40:00-04:00</updated>
    <id>http://brucelefebvre.com/blog/2013/08/22/setting-up-a-dispatcher-on-os-x</id>
    <content type="html"><![CDATA[<p>The dispatcher is an important piece of a secure, stable, and solidly-performing AEM implementation. According to <a href="http://dev.day.com/docs/en/cq/current/deploying/dispatcher.html">the documentation</a> it can provide caching, load balancing, as well as help to protect your publish instances from attack. For such a multifaceted tool it seems to receive very little attention during the dev process, typically called to action in the final stages of a deployment when most of the dev work has already been done. I propose that developers (including myself) could write better code if they had a deeper understanding of this tool, which is why I went through the process of setting one up on my Mac. What follows are my notes.</p>

<p>Here's what you'll need to get started:</p>

<!-- more -->


<ul>
<li>OS X machine with Apache installed and enabled</li>
<li>AEM 5.6.1 quickstart

<ul>
<li>author on :4502</li>
<li>publish on :4503</li>
</ul>
</li>
</ul>


<p>Figure out which version of Apache httpd you're working with:</p>

<pre><code>$ httpd -v
</code></pre>

<p>Download and extract the correct dispatcher version for your httpd:</p>

<p><a href="https://dev.day.com/packageshare/packages/public/day/dispatcher.html">https://dev.day.com/packageshare/packages/public/day/dispatcher.html</a></p>

<p>Inside the extracted directory you will find a file named 'dispatcher-apache&lt;version&gt;.so'. Copy this file to /usr/libexec/apache2. In my case:</p>

<pre><code>$ sudo cp dispatcher-apache2.2-4.1.4.so /usr/libexec/apache2
</code></pre>

<p>Head to the apache2 modules directory:</p>

<pre><code>$ cd /usr/libexec/apache2/
</code></pre>

<p> Create a symlink to the dispatcher module you just copied over:</p>

<pre><code>$ sudo ln -s dispatcher-apache2.2-4.1.4.so mod_dispatcher.so
</code></pre>

<p>Head to /etc/apache2 to configure it:</p>

<pre><code>$ cd /etc/apache2
</code></pre>

<p>Open httpd.conf (as root) with your editor of choice and add the following line to the end of the LoadModule section (line 119 in my case):</p>

<pre><code>LoadModule dispatcher_module libexec/apache2/mod_dispatcher.so
</code></pre>

<p>After this line, add the following configuration:</p>

<pre><code># configure the minimal setting for the dispatcher
# the main configuration is read from the 'DispatcherConfig' file.
&lt;IfModule disp_apache2.c&gt;
    # location of the configuration file. eg: 'conf/dispatcher.any'
    DispatcherConfig /etc/apache2/conf/dispatcher.any

    # location of the dispatcher log file. eg: 'logs/dispatcher.log'
    DispatcherLog    /var/log/apache2/dispatcher.log

    # log level for the dispatcher log
    # 0 Errors
    # 1 Warnings
    # 2 Infos
    # 3 Debug
    DispatcherLogLevel 3

    # if turned to 1, the dispatcher looks like a normal module
    # since build 5210, this setting has no effect, since it used to crash
    # apache if set to 0.
    DispatcherNoServerHeader 1

    # if turned to 1, request to / are not handled by the dispatcher
    # use the mod_alias then for the correct mapping
    DispatcherDeclineRoot 0
&lt;/IfModule&gt;

&lt;Directory /&gt;
    &lt;IfModule disp_apache2.c&gt;
        # enable dispatcher for ALL request. if this is too restrictive,
        # move it to another location
        SetHandler dispatcher-handler
    &lt;/IfModule&gt;

    Options FollowSymLinks
    AllowOverride None
&lt;/Directory&gt;
</code></pre>

<p>Create a directory named 'conf' in /etc/apache2</p>

<pre><code>$ sudo mkdir /etc/apache2/conf
</code></pre>

<p>From the extracted dispatcher directory, copy the provided dispatcher.any to conf:</p>

<pre><code>$ cd ~/Downloads/dispatcher-apache2.2-darwin-x86-64-4.1.4/conf/
$ sudo cp dispatcher.any /etc/apache2/conf/
</code></pre>

<p>Set the host name and port of your publish instance in dispatcher.any (search for the existing values):</p>

<pre><code>/hostname "127.0.0.1"
/port "4503"
</code></pre>

<p>Allow requests with authorized header (uncomment and change value) in dispatcher.any:</p>

<pre><code>/allowAuthorized "1"
</code></pre>

<p>Set the document root directory (search for the existing value):</p>

<pre><code>/docroot "/Library/WebServer/Documents"
</code></pre>

<p>Check your config syntax:</p>

<pre><code>$ sudo apachectl configtest
</code></pre>

<p>The previous command should have outputted 'Syntax OK'.</p>

<p>Did it not? You may need to correct your configuration. 'apachectl configtest' should be able to tell you on which line your config is broken.</p>

<p>Give your httpd document root directory to the _www user and group:</p>

<pre><code>$ sudo chown _www:_www /Library/WebServer/Documents/
</code></pre>

<p>Stop Apache httpd:</p>

<pre><code>$ sudo apachectl stop
</code></pre>

<p>In another terminal window (or tab), tail the following log files for errors:</p>

<pre><code>$ tail -f /var/log/apache2/error_log /var/log/apache2/dispatcher.log
</code></pre>

<p>Start Apache httpd back up:</p>

<pre><code>$ sudo apachectl start
</code></pre>

<p>Barring any errors in the logs you should now be able to browse your AEM publish content via the dispatcher:</p>

<p><a href="http://localhost/content/geometrixx-media/en.html">http://localhost/content/geometrixx-media/en.html</a></p>

<p>You can also poke around /Library/WebServer/Documents/ to see how the static content is stored on the file system.</p>

<p>That's it! You've just configured your very own dispatcher. I've only scratched the surface here and really glazed over much of the configuration, so make sure to read the following resources before releasing this dispatcher into the wild:</p>

<p>Dispatcher - <a href="http://dev.day.com/docs/en/cq/current/deploying/dispatcher.html">http://dev.day.com/docs/en/cq/current/deploying/dispatcher.html</a></p>

<p>Configuring Dispatcher - <a href="http://dev.day.com/docs/en/cq/current/deploying/dispatcher/disp_config.html">http://dev.day.com/docs/en/cq/current/deploying/dispatcher/disp_config.html</a></p>

<p>Security Checklist - <a href="http://dev.day.com/docs/en/cq/current/deploying/security_checklist.html">http://dev.day.com/docs/en/cq/current/deploying/security_checklist.html</a></p>
]]></content>
  </entry>
  
</feed>
